# Dockerfile.base - Base image with models and dependencies
FROM python:3.10-slim AS base

WORKDIR /app

# Install system dependencies (these rarely change)
RUN apt-get update -o Acquire::Check-Valid-Until=false -o Acquire::Check-Date=false && \
    apt-get install -y \
        ansible \
        openssh-client \
        sshpass \
        procps \
        sudo \
        postgresql-client \
        curl \
        wget \
        git \
        && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install Python dependencies (copy requirements first for better caching)
COPY backend/requirements.txt /app/backend/requirements.txt
RUN pip install --no-cache-dir -r /app/backend/requirements.txt

# Download GPT4All models (this is the time-consuming part)
COPY download_models.py /app/download_models.py
RUN pip install gpt4all>=2.5.0 && \
    python3 download_models.py && \
    rm download_models.py

# Create user and group with same IDs as host infadm user
ARG USER_ID=1003
ARG GROUP_ID=1002
ARG USERNAME=infadm
ARG GROUP_NAME=aimsys

RUN groupadd -g $GROUP_ID $GROUP_NAME && \
    useradd -u $USER_ID -g $GROUP_NAME -m -s /bin/bash $USERNAME

# Create necessary directories with proper ownership
RUN mkdir -p /home/users/$USERNAME/.ssh \
             /app/fixfiles/AllFts \
             /app/logs \
             /tmp/ansible-ssh \
             /app/ssh-keys && \
    chmod 700 /home/users/$USERNAME/.ssh && \
    chmod -R 777 /tmp/ansible-ssh && \
    chown -R $USERNAME:$GROUP_NAME /app && \
    chown -R $USERNAME:$GROUP_NAME /home/users/$USERNAME

# Give sudo access to infadm user
RUN echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Set environment variables
ENV HOME=/home/users/$USERNAME
ENV FLASK_ENV=production
ENV ANSIBLE_HOST_KEY_CHECKING=False
ENV ANSIBLE_SSH_CONTROL_PATH=/tmp/ansible-ssh/%h-%p-%r
ENV ANSIBLE_SSH_CONTROL_PATH_DIR=/tmp/ansible-ssh
ENV PYTHONUNBUFFERED=1
ENV LOG_FILE_PATH=/app/logs/application.log
ENV DEPLOYMENT_LOGS_DIR=/app/logs
ENV GPT4ALL_MODEL_PATH=/app/models
ENV GPT4ALL_MODEL=orca-mini-3b-gguf2-q4_0.gguf

# Switch to the infadm user
USER $USERNAME

# This base image contains:
# - All system dependencies
# - Python packages
# - GPT4All models
# - User setup
# - Environment configuration
